/* @ts-nocheck */
import React, { useMemo, useState, useEffect } from "react";
import {
  LineChart,
  Line,
  ResponsiveContainer,
  ScatterChart,
  Scatter,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  AreaChart,
  Area,
  BarChart,
  Bar,
  ReferenceLine,
  Cell,
} from "recharts";

// =====================================
// Dummy Data Builders (aligned to your schema)
// - We DO NOT use clicks/impressions.
// - We simulate only fields derivable from Page, PageVersion, PageStats, PageDailyStats.
// =====================================
const rand = (min: number, max: number) => Math.round(min + Math.random() * (max - min));
const spark = (n = 14, base = 100, vol = 12) => Array.from({ length: n }, (_, i) => ({ i, v: base + rand(-vol, vol) }));

const siteOverview = {
  updatedAt: "2025-08-11 17:07",
  kpis: [
    { key: "users", label: "总用户数", value: 27560, delta: 2.1, series: spark(14, 120, 20) },
    { key: "pages", label: "总页面数", value: 31229, delta: 1.4, series: spark(14, 140, 18) },
    { key: "votes", label: "总投票数", value: 922775, delta: 3.7, series: spark(14, 200, 30) },
    { key: "newToday", label: "今日新增投票", value: 74831, delta: 0.9, series: spark(14, 90, 15) },
  ],
};

// 按你的 schema 构造页面项（模拟 Page/PageVersion/PageStats/PageDailyStats 汇总）
const trendingPages = Array.from({ length: 18 }).map((_, idx) => {
  const uv7 = rand(20, 500); // 近 7d uniqueVoters 汇总（来自 PageDailyStats.uniqueVoters）
  const recentVotes = rand(30, 1500); // 近 7d totalVotes 增量
  return {
    id: idx + 1,
    title: `SCP-${1000 + idx}`,
    rating: rand(30, 120),
    voteCount: rand(400, 2000),
    velocity: Math.max(1, Math.round(recentVotes / 7)), // 日均投票
    controversy: Math.round((Math.random() * 0.85 + 0.05) * 100) / 100, // PageStats.controversy [0,1]
    wilson95: Math.round((Math.random() * 0.5 + 0.4) * 100) / 100, // PageStats.wilson95 [0,1]
    uniqueVoters7d: uv7, // 可从 PageDailyStats 聚合
    ageDays: rand(1, 360), // Page.firstPublishedAt 推算
    revisions7d: rand(0, 8), // PageDailyStats.revisions 聚合
    spark: spark(20, 100 + rand(-10, 10), 16),
    tags: ["safe", "scp", idx % 3 === 0 ? "人形" : idx % 3 === 1 ? "机械" : "地点"].slice(0, 3),
  };
});

const risingTags = [
  { tag: "bright博士", delta: 42, series: spark(18, 100, 25) },
  { tag: "kondraki", delta: 31, series: spark(18, 110, 20) },
  { tag: "goi-format", delta: 27, series: spark(18, 95, 22) },
  { tag: "翻译", delta: 19, series: spark(18, 90, 18) },
  { tag: "原创", delta: 15, series: spark(18, 105, 24) },
];

const seriesUtil = [
  { series: 6, totalSlots: 1000, usedSlots: 742 },
  { series: 7, totalSlots: 1000, usedSlots: 128 },
  { series: 5, totalSlots: 1000, usedSlots: 1000 },
];

const milestones = [
  { type: "WEEK", label: "本周首次破 +100 的页面", page: "SCP-1898", rating: 108, at: "08-10" },
  { type: "DAY", label: "今日最高争议度", page: "SCP-CN-1384-3", rating: 72, at: "08-11" },
  { type: "MONTH", label: "本月新晋前 50", page: "SCP-199-DE", rating: 135, at: "08-03" },
];

// =====================================
// Utilities
// =====================================
const fmt = (n: number) => n.toLocaleString();
const cls = (...names: (string | false | undefined)[]) => names.filter(Boolean).join(" ");
const clamp = (v: number, a = 0, b = 1) => Math.min(b, Math.max(a, v));
const norm = (v: number, min: number, max: number) => clamp((v - min) / Math.max(1e-6, max - min));

// 模式常量
type ModeKey = "top" | "fair" | "random";
const FEED_MODES: [ModeKey, string][] = [
  ["fair", "公平混排"],
  ["top", "Top高分"],
  ["random", "惊喜"],
];

// =====================================
// Fair-Mix Ranking（不依赖点击/曝光）
// - 质量：rating 或 wilson95（二选一，优先 wilson95）
// - 速度：近7日日均投票 velocity
// - 低触达：使用 uniqueVoters7d 的反向值（越少越优先）
// - 新鲜：ageDays 衰减
// - 多样性：按标签降权
// - 探索：随机噪声（可调）
// =====================================
function fairMix(items: any[], opts?: { limit?: number; explore?: number; diversity?: number }) {
  const limit = opts?.limit ?? 9;
  const explore = clamp(opts?.explore ?? 0.25, 0, 1);
  const diversity = clamp(opts?.diversity ?? 0.25, 0, 1);

  const qArr = items.map((x) => x.wilson95 ?? x.rating);
  const rMin = Math.min(...qArr), rMax = Math.max(...qArr);
  const vMin = Math.min(...items.map((x) => x.velocity));
  const vMax = Math.max(...items.map((x) => x.velocity));
  const uMin = Math.min(...items.map((x) => x.uniqueVoters7d));
  const uMax = Math.max(...items.map((x) => x.uniqueVoters7d));

  const prepared = items.map((x) => {
    const quality = norm(x.wilson95 ?? x.rating, rMin, rMax);
    const speed = norm(x.velocity, vMin, vMax);
    const lowReach = 1 - norm(x.uniqueVoters7d, uMin, uMax);
    const novelty = clamp(1 - x.ageDays / 90);
    const noise = Math.random();

    // 权重：质量 35%、低触达 25%、新鲜 20%、速度 20%（可按需调）
    const baseScore = 0.35 * quality + 0.25 * lowReach + 0.2 * novelty + 0.2 * speed + explore * 0.25 * noise;

    const reasons: string[] = [];
    if (lowReach > 0.6) reasons.push("低触达加权");
    if (novelty > 0.6) reasons.push("新鲜度加权");
    if (quality > 0.7) reasons.push("质量较高");
    if (x.controversy > 0.6) reasons.push("争议度关注");

    return { ...x, baseScore, reasons };
  });

  const picked: any[] = [];
  const tagCount: Record<string, number> = {};
  const left = [...prepared];

  while (picked.length < Math.min(limit, left.length)) {
    let best: any | null = null;
    let bestScore = -Infinity;
    let bestIdx = -1;

    for (let i = 0; i < left.length; i++) {
      const x = left[i];
      const overlap = x.tags?.reduce((acc: number, t: string) => acc + (tagCount[t] ? 1 : 0), 0) || 0;
      const divPenalty = diversity * (overlap / Math.max(1, x.tags?.length || 1));
      const score = x.baseScore - divPenalty;
      if (score > bestScore) {
        best = x;
        bestScore = score;
        bestIdx = i;
      }
    }

    if (best) {
      const why = [...best.reasons];
      if (best.baseScore - bestScore > 0.05) why.push("已做相似标签降权");
      picked.push({ ...best, why });
      for (const t of best.tags || []) tagCount[t] = (tagCount[t] || 0) + 1;
      left.splice(bestIdx, 1);
    } else {
      break;
    }
  }

  return picked;
}

// 简易随机
function shuffled<T>(arr: T[]) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// =====================================
// Lightweight Tests (console-based)
// =====================================
function runTests() {
  // 1) No crash on empty input
  console.assert(Array.isArray(fairMix([], { limit: 5 })) && fairMix([], { limit: 5 }).length === 0, "fairMix empty input failed");

  // 2) Low reach should rank higher when other factors equal (explore=0, no noise)
  const base = {
    rating: 80,
    wilson95: 0.8,
    velocity: 10,
    controversy: 0.3,
    ageDays: 5,
    tags: ["safe"],
    spark: [],
    voteCount: 1000,
  } as any;
  const a = { ...base, id: 1, uniqueVoters7d: 50 };
  const b = { ...base, id: 2, uniqueVoters7d: 500 };
  const res = fairMix([a, b], { limit: 2, explore: 0, diversity: 0 });
  console.assert(res[0].id === 1, "low reach should outrank high reach when equal quality");

  // 3) Diversity penalty should avoid selecting only same-tag items
  const c = { ...base, id: 3, uniqueVoters7d: 60, tags: ["safe"] };
  const d = { ...base, id: 4, uniqueVoters7d: 70, tags: ["机械"] };
  const res2 = fairMix([a, c, d], { limit: 2, explore: 0, diversity: 1 });
  const hasDifferentTags = new Set(res2.flatMap((x:any)=>x.tags)).size > 1;
  console.assert(hasDifferentTags, "diversity should produce mixed tags");
}

// =====================================
// Primitives (UI) — refined visuals
// =====================================
function Ribbon({ children }: { children: React.ReactNode }) {
  return (
    <div className="relative border-y border-neutral-800 bg-neutral-950/80 py-2 text-xs tracking-wide text-neutral-400">
      <div className="absolute inset-0 pointer-events-none [background-image:linear-gradient(to_right,transparent,transparent_97%,#111827_97%)] [background-size:12px_100%] opacity-40" />
      <div className="max-w-7xl mx-auto px-4 flex items-center gap-4 overflow-x-auto">{children}</div>
    </div>
  );
}

function SearchBox() {
  return (
    <div className="relative w-full max-w-md">
      <input placeholder="搜索页面 / 用户 / 标签…" className="w-full bg-neutral-900 border border-neutral-800 rounded-sm px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-emerald-600" />
      <div className="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-neutral-500 border border-neutral-700 rounded-sm px-1">⌘K</div>
    </div>
  );
}

function KpiTile({ label, value, delta, series }: { label: string; value: number; delta: number; series: { i: number; v: number }[] }) {
  const deltaPos = delta >= 0;
  return (
    <div className="relative rounded-sm p-4 overflow-hidden bg-neutral-950 border border-neutral-800">
      <div className="absolute inset-0 pointer-events-none [background:repeating-linear-gradient(90deg,transparent,transparent_11px,#0b0b0c_11px,#0b0b0c_12px)] opacity-20" />
      <div className="text-[11px] tracking-wide uppercase text-neutral-400">{label}</div>
      <div className="mt-1 flex items-baseline gap-2">
        <div className="text-3xl font-mono text-neutral-100">{fmt(value)}</div>
        <span className={cls("text-xs font-medium", deltaPos ? "text-emerald-500" : "text-red-500")}>{deltaPos ? "▲" : "▼"} {Math.abs(delta).toFixed(1)}%</span>
      </div>
      <div className="mt-3 h-10 border border-neutral-800 bg-neutral-900">
        <ResponsiveContainer width="100%" height="100%">
          <LineChart data={series} margin={{ top: 6, right: 8, bottom: 0, left: 8 }}>
            <Line type="monotone" dataKey="v" dot={false} strokeWidth={2} />
          </LineChart>
        </ResponsiveContainer>
      </div>
    </div>
  );
}

function SectionHeader({ title, action }: { title: string; action?: React.ReactNode }) {
  return (
    <div className="flex items-center justify-between border-b border-neutral-800 pb-2">
      <div className="flex items-center gap-3">
        <div className="h-3 w-1 bg-emerald-500" />
        <h2 className="text-sm font-semibold tracking-wider uppercase text-neutral-200">{title}</h2>
      </div>
      {action && <div className="text-xs text-neutral-400">{action}</div>}
    </div>
  );
}

function RisingTagsStrip() {
  return (
    <div className="overflow-auto whitespace-nowrap py-2">
      <div className="inline-flex gap-3">
        {risingTags.map((t) => (
          <div key={t.tag} className="min-w-[220px] border border-neutral-800 rounded-sm p-3 bg-neutral-950">
            <div className="flex items-center justify-between">
              <div className="text-xs font-medium text-neutral-300">#{t.tag}</div>
              <div className="text-xs text-emerald-500">+{t.delta}%</div>
            </div>
            <div className="mt-2 h-8 border border-neutral-800 bg-neutral-900">
              <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={t.series} margin={{ top: 2, right: 6, bottom: 0, left: 6 }}>
                  <Area dataKey="v" strokeWidth={1.5} fillOpacity={0.2} />
                </AreaChart>
              </ResponsiveContainer>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

function Quadrant() {
  const data = trendingPages.map((p) => ({ x: p.velocity, y: p.controversy, r: Math.sqrt(p.voteCount) / 2, name: p.title }));
  return (
    <div className="h-64 border border-neutral-800 rounded-sm bg-neutral-950">
      <ResponsiveContainer width="100%" height="100%">
        <ScatterChart margin={{ top: 10, right: 10, bottom: 10, left: 10 }}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis type="number" dataKey="x" name="速度" unit="/d" tick={{ fill: "#9ca3af", fontSize: 12 }} stroke="#27272a" />
          <YAxis type="number" dataKey="y" name="争议度" domain={[0, 1]} tick={{ fill: "#9ca3af", fontSize: 12 }} stroke="#27272a" />
          <ReferenceLine x={20} stroke="#374151" />
          <ReferenceLine y={0.5} stroke="#374151" />
          <Tooltip cursor={{ strokeDasharray: "3 3" }} contentStyle={{ background: "#111827", border: "1px solid #27272a", color: "#e5e7eb" }} />
          <Scatter data={data}>
            {data.map((entry, index) => (
              <Cell key={`cell-${index}`} />
            ))}
          </Scatter>
        </ScatterChart>
      </ResponsiveContainer>
    </div>
  );
}

function SeriesUtil() {
  return (
    <div className="space-y-3">
      {seriesUtil.map((s) => {
        const pct = Math.round((s.usedSlots / s.totalSlots) * 100);
        return (
          <div key={s.series} className="border border-neutral-800 rounded-sm p-3 bg-neutral-950">
            <div className="flex items-center justify-between text-xs text-neutral-300">
              <div>Series {s.series}</div>
              <div>{s.usedSlots}/{s.totalSlots} · <span className={pct >= 90 ? "text-red-500" : pct >= 60 ? "text-amber-400" : "text-emerald-500"}>{pct}%</span></div>
            </div>
            <div className="mt-2 h-4 relative bg-neutral-900 border border-neutral-800">
              <div className="absolute inset-0 bg-gradient-to-r from-neutral-900 via-neutral-900 to-neutral-900 [background-size:16px_100%] [background-image:linear-gradient(to_right,transparent_0,transparent_14px,#27272a_14px,#27272a_16px)]" />
              <div className="h-full bg-emerald-600" style={{ width: pct + "%" }} />
            </div>
          </div>
        );
      })}
    </div>
  );
}

function VelocityBars() {
  const data = trendingPages.map((p) => ({ name: p.title, v: p.velocity })).sort((a, b) => b.v - a.v).slice(0, 8).reverse();
  return (
    <div className="h-64 border border-neutral-800 rounded-sm bg-neutral-950">
      <ResponsiveContainer width="100%" height="100%">
        <BarChart layout="vertical" data={data} margin={{ top: 10, right: 16, bottom: 0, left: 40 }}>
          <CartesianGrid strokeDasharray="3 3" />
          <XAxis type="number" tick={{ fill: "#9ca3af", fontSize: 12 }} stroke="#27272a" />
          <YAxis type="category" dataKey="name" tick={{ fill: "#9ca3af", fontSize: 12 }} width={80} stroke="#27272a" />
          <Tooltip contentStyle={{ background: "#111827", border: "1px solid #27272a", color: "#e5e7eb" }} />
          <Bar dataKey="v">
            {data.map((_, i) => (
              <Cell key={i} />
            ))}
          </Bar>
        </BarChart>
      </ResponsiveContainer>
    </div>
  );
}

function PageCard({ p, onTogglePin, pinned }: { p: any; onTogglePin: (id: number) => void; pinned: boolean }) {
  return (
    <div className="group relative border border-neutral-800 rounded-sm p-3 bg-neutral-950 flex flex-col gap-2">
      <div className="absolute inset-0 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity [background:radial-gradient(600px_120px_at_0%_0%,rgba(16,185,129,0.05),transparent_60%)]" />
      <div className="flex items-center justify-between">
        <div className="font-mono text-neutral-100">{p.title}</div>
        <button onClick={() => onTogglePin(p.id)} className={cls("text-xs border px-2 py-0.5", pinned ? "border-emerald-600 text-emerald-400" : "border-neutral-700 text-neutral-400")}>{pinned ? "Pinned" : "Pin"}</button>
      </div>
      <div className="text-[11px] text-neutral-400 flex flex-wrap gap-1">
        {p.tags?.map((t: string) => (
          <span key={t} className="inline-block border px-1 py-0.5 border-neutral-700">{t}</span>
        ))}
        <span className="ml-auto text-neutral-500">{p.ageDays}d</span>
      </div>
      <div className="grid grid-cols-4 gap-2 text-xs">
        <div className="border border-neutral-800 p-2">
          <div className="text-neutral-400">评分</div>
          <div className="text-neutral-100 text-lg">{p.rating}</div>
        </div>
        <div className="border border-neutral-800 p-2">
          <div className="text-neutral-400">投票</div>
          <div className="text-neutral-100 text-lg">{fmt(p.voteCount)}</div>
        </div>
        <div className="border border-neutral-800 p-2">
          <div className="text-neutral-400">速度</div>
          <div className="text-neutral-100 text-lg">{p.velocity}/d</div>
        </div>
        <div className="border border-neutral-800 p-2">
          <div className="text-neutral-400">独立投票(7d)</div>
          <div className="text-neutral-100 text-lg">{p.uniqueVoters7d}</div>
        </div>
      </div>
      <div className="h-12 border border-neutral-800 bg-neutral-900">
        <ResponsiveContainer width="100%" height="100%">
          <LineChart data={p.spark} margin={{ top: 4, right: 6, bottom: 0, left: 6 }}>
            <Line type="monotone" dataKey="v" dot={false} strokeWidth={1.8} />
          </LineChart>
        </ResponsiveContainer>
      </div>
      {p.why && (
        <div className="text-[11px] text-neutral-400">Why: {p.why.join(" · ")}</div>
      )}
    </div>
  );
}

function CompareDrawer({ items, onClose }: { items: any[]; onClose: () => void }) {
  return (
    <div className="fixed bottom-4 right-4 left-4 md:left-auto md:w-[560px] bg-neutral-950 border border-neutral-800 rounded-sm p-4 shadow-xl">
      <div className="flex items-center justify-between border-b border-neutral-800 pb-2">
        <div className="flex items-center gap-2"><div className="h-4 w-1 bg-emerald-500"/><div className="text-sm font-semibold tracking-wider uppercase text-neutral-200">Compare</div></div>
        <button onClick={onClose} className="text-xs text-neutral-400 border border-neutral-700 px-2 py-0.5">Close</button>
      </div>
      <div className="mt-3 grid grid-cols-3 gap-2 text-xs">
        {items.map((p) => (
          <div key={p.id} className="border border-neutral-800 p-2">
            <div className="font-mono text-neutral-100">{p.title}</div>
            <div className="mt-2 grid grid-cols-3 gap-1">
              <div>
                <div className="text-neutral-500">评分</div>
                <div className="text-neutral-100 text-sm">{p.rating}</div>
              </div>
              <div>
                <div className="text-neutral-500">投票</div>
                <div className="text-neutral-100 text-sm">{fmt(p.voteCount)}</div>
              </div>
              <div>
                <div className="text-neutral-500">速度</div>
                <div className="text-neutral-100 text-sm">{p.velocity}/d</div>
              </div>
            </div>
            <div className="mt-2 h-10 border border-neutral-800 bg-neutral-900">
              <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={p.spark} margin={{ top: 4, right: 6, bottom: 0, left: 6 }}>
                  <Area dataKey="v" strokeWidth={1.5} fillOpacity={0.2} />
                </AreaChart>
              </ResponsiveContainer>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// =====================================
// Root Page（更精致的 UI + 公平混排）
// =====================================
export default function App() {
  const [pinned, setPinned] = useState<number[]>([]);
  const [showCompare, setShowCompare] = useState(false);
  const [mode, setMode] = useState<ModeKey>("fair");
  const [explore, setExplore] = useState(0.3); // 探索强度（0~1）
  const [diverse, setDiverse] = useState(true); // 标签去同质化

  useEffect(() => { runTests(); }, []);

  const baseTop = useMemo(() => [...trendingPages].sort((a, b) => (b.wilson95 ?? b.rating) - (a.wilson95 ?? a.rating)).slice(0, 9), []);
  const fairList = useMemo(() => fairMix(trendingPages, { limit: 9, explore, diversity: diverse ? 0.25 : 0 }), [explore, diverse]);
  const randomList = useMemo(() => shuffled(trendingPages).slice(0, 9), [explore, diverse]);
  const feed = mode === "top" ? baseTop : mode === "random" ? randomList : fairList;
  const pinnedItems = feed.filter((p) => pinned.includes(p.id));

  return (
    <div className="min-h-screen bg-neutral-950 text-neutral-200 [background:radial-gradient(1200px_300px_at_50%_-10%,rgba(16,185,129,0.05),transparent_60%)]">
      {/* Header */}
      <header className="border-b border-neutral-800">
        <div className="max-w-7xl mx-auto px-4 py-3 flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-6 justify-between">
          <div className="flex items-center gap-3">
            <div className="h-7 w-7 bg-emerald-600" />
            <div className="font-semibold tracking-wide">SCPperDB · 信息看板</div>
          </div>
          <SearchBox />
          <div className="text-xs text-neutral-400">数据更新时间：{siteOverview.updatedAt}</div>
        </div>
      </header>

      {/* Ribbon filters */}
      <Ribbon>
        <div className="flex items-center gap-2">
          <span className="text-neutral-500">模式</span>
          <div className="inline-flex border border-neutral-800 rounded-sm overflow-hidden">
            {FEED_MODES.map(([k, label]) => (
              <button key={k} onClick={() => setMode(k)} className={cls("px-3 py-1", mode === k ? "bg-emerald-600 text-neutral-900" : "bg-neutral-950 text-neutral-300")}>{label}</button>
            ))}
          </div>
        </div>
        <div className="flex items-center gap-2">
          <span className="text-neutral-500">探索度</span>
          <input type="range" min={0} max={1} step={0.05} value={explore} onChange={(e)=>setExplore(parseFloat(e.target.value))} className="accent-emerald-600" />
          <span className="text-neutral-300 w-10 text-right">{(explore*100).toFixed(0)}%</span>
        </div>
        <label className="inline-flex items-center gap-1">
          <input type="checkbox" checked={diverse} onChange={(e)=>setDiverse(e.target.checked)} />
          <span className="text-neutral-300">去同质化</span>
        </label>
        <button onClick={()=>{ setExplore((v)=> v + 0.0001); }} className="border border-neutral-700 px-3 py-1">再来一批</button>
      </Ribbon>

      {/* Body */}
      <main className="max-w-7xl mx-auto px-4 py-6 space-y-8">
        {/* KPIs */}
        <section>
          <SectionHeader title="站点总览" action={<span>近 14 日</span>} />
          <div className="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
            {siteOverview.kpis.map((k) => (
              <KpiTile key={k.key} label={k.label} value={k.value} delta={k.delta} series={k.series} />
            ))}
          </div>
        </section>

        {/* Corridor */}
        <section className="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div>
            <SectionHeader title="投票速度 Top" action={<span>7d</span>} />
            <div className="mt-3"><VelocityBars /></div>
          </div>
          <div>
            <SectionHeader title="争议度象限" action={<span>速度 / 争议</span>} />
            <div className="mt-3"><Quadrant /></div>
          </div>
          <div>
            <SectionHeader title="Rising Tags" action={<span>近 30 天</span>} />
            <div className="mt-3"><RisingTagsStrip /></div>
          </div>
        </section>

        {/* Milestones & Series */}
        <section className="grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div className="lg:col-span-2">
            <SectionHeader title="今日里程碑" />
            <div className="mt-3 space-y-3">
              {milestones.map((m, i) => (
                <div key={i} className="border border-neutral-800 rounded-sm p-3 bg-neutral-950 flex items-center gap-3">
                  <div className="text-[10px] uppercase text-neutral-400 w-14 text-center border border-neutral-800 py-1">{m.type}</div>
                  <div className="flex-1 text-sm text-neutral-200">{m.label}</div>
                  <div className="text-xs text-neutral-300 flex items-center gap-3">
                    <span className="inline-block px-1.5 py-0.5 border border-neutral-700">{m.page}</span>
                    <span className="text-emerald-500">评分 {m.rating}</span>
                    <span className="text-neutral-500">{m.at}</span>
                  </div>
                </div>
              ))}
            </div>
          </div>
          <div>
            <SectionHeader title="系列占位率" />
            <div className="mt-3"><SeriesUtil /></div>
          </div>
        </section>

        {/* Feed List */}
        <section>
          <SectionHeader title="精选页面（反马太效应实验）" />
          <div className="mt-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            {feed.map((p) => (
              <PageCard key={p.id} p={p} pinned={pinned.includes(p.id)} onTogglePin={(id)=> setPinned((s) => (s.includes(id) ? s.filter((x) => x !== id) : [...s, id]))} />
            ))}
          </div>
          {pinnedItems.length > 0 && (
            <div className="mt-4 flex justify-end">
              <button onClick={() => setShowCompare(true)} className="text-xs border border-emerald-600 text-emerald-400 px-3 py-1">打开对比抽屉（{pinnedItems.length}）</button>
            </div>
          )}
        </section>
      </main>

      {/* Compare Drawer */}
      {showCompare && <CompareDrawer items={pinnedItems} onClose={() => setShowCompare(false)} />}
    </div>
  );
}
