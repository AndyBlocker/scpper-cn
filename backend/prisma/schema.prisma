generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Attribution {
  id        Int      @id @default(autoincrement())
  pageVerId Int
  type      String
  order     Int      @default(0)
  date      DateTime?
  userId    Int?
  anonKey   String?

  pageVersion PageVersion @relation(fields: [pageVerId], references: [id])
  user        User?       @relation(fields: [userId], references: [id])

  @@unique([pageVerId, type, order, userId], name: "Attribution_unique_constraint") 
  @@unique([pageVerId, type, order, anonKey], name: "Attribution_anon_unique_constraint")
  @@index([pageVerId])
  @@index([userId])
}

model DirtyPage {
  pageId     Int      @id
  needPhaseB Boolean
  needPhaseC Boolean
  reasons    String[]
  donePhaseB Boolean  @default(false)
  donePhaseC Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  page       Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@index([needPhaseB, donePhaseB])
  @@index([needPhaseC, donePhaseC])
}

model DirtyPageBackup {
  pageId      Int?
  needPhaseB  Boolean?
  needPhaseC  Boolean?
  reasons     String[]
  donePhaseB  Boolean?
  donePhaseC  Boolean?
  createdAt   DateTime?
  updatedAt   DateTime?
  url         String?
  backup_time DateTime?
  id          Int       @id @default(autoincrement())
}

model Page {
  id             Int           @id @default(autoincrement())
  url            String        @unique
  urlKey         String
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  pageUuid       String?       @unique // Business UUID for stable page identification
  historicalUrls String[]      // Track previous URLs for renamed pages
  dirtyPage      DirtyPage?
  versions       PageVersion[]
}

model PageMetaStaging {
  url              String   @id
  wikidotId        Int?
  title            String?
  rating           Int?
  voteCount        Int?
  revisionCount    Int?
  tags             String[]
  isDeleted        Boolean  @default(false)
  estimatedCost    Int?
  lastSeenAt       DateTime @default(now())
  category         String?
  parentUrl        String?
  childCount       Int?
  attributionCount Int?
  voteUp           Int?
  voteDown         Int?

  @@index([lastSeenAt])
}

model PageStats {
  id              Int   @id @default(autoincrement())
  pageVersionId   Int   @unique
  uv              Int
  dv              Int
  wilson95        Float
  controversy     Float
  likeRatio       Float
  
  pageVersion     PageVersion @relation(fields: [pageVersionId], references: [id])
}

model PageVersion {
  id            Int           @id @default(autoincrement())
  pageId        Int
  wikidotId     Int?
  title         String?
  rating        Int?
  voteCount     Int?
  revisionCount Int?
  textContent   String?
  source        String?
  tags          String[]
  validFrom     DateTime
  validTo       DateTime?
  isDeleted     Boolean       @default(false)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  revisions     Revision[]
  votes         Vote[]
  attributions  Attribution[]
  stats         PageStats?
  sourceVersions SourceVersion[]  // 关联的source code版本历史
  
  page          Page          @relation(fields: [pageId], references: [id])

  @@index([pageId])
  @@index([rating])
  @@index([validTo])
  @@index([wikidotId])
}

model Revision {
  id            Int            @id @default(autoincrement())
  pageVersionId Int
  wikidotId     Int
  timestamp     DateTime
  type          String
  comment       String?
  userId        Int?
  
  pageVersion   PageVersion    @relation(fields: [pageVersionId], references: [id])
  user          User?          @relation(fields: [userId], references: [id])
  sourceVersions SourceVersion[]  // 关联的source code版本
  
  @@unique([pageVersionId, wikidotId])
  @@index([pageVersionId])
  @@index([pageVersionId, timestamp])
  @@index([userId])
  @@index([timestamp])
}

model SeriesStats {
  id              Int      @id @default(autoincrement())
  seriesNumber    Int      @unique
  isOpen          Boolean  @default(false)
  totalSlots      Int
  usedSlots       Int      @default(0)
  usagePercentage Float    @default(0.0)
  milestonePageId Int?
  lastUpdated     DateTime @default(now())
  createdAt       DateTime @default(now())

  @@index([isOpen])
  @@index([seriesNumber])
  @@index([usagePercentage])
}

model SiteStats {
  id          Int      @id @default(autoincrement())
  date        DateTime @unique @db.Date
  totalUsers  Int      @default(0)
  activeUsers Int      @default(0)  // Users with firstActivityAt
  totalPages  Int      @default(0)
  totalVotes  Int      @default(0)
  newUsersToday Int    @default(0)  // New users by firstActivityAt on this date
  newPagesToday Int    @default(0)  // New pages created on this date
  newVotesToday Int    @default(0)  // New votes on this date
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
}

model SourceVersion {
  id              Int         @id @default(autoincrement())
  pageVersionId   Int         // 关联的PageVersion
  revisionId      Int?        // 关联的SOURCE_CHANGED revision (可选，初始版本可能没有revision)
  revisionNumber  Int?        // Revision的wikidotId，用于快速查找
  source          String?     // 页面源代码
  textContent     String?     // 渲染后内容
  timestamp       DateTime    @default(now())
  isLatest        Boolean     @default(false) // 标记是否为当前最新版本
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  pageVersion     PageVersion @relation(fields: [pageVersionId], references: [id], onDelete: Cascade)
  revision        Revision?   @relation(fields: [revisionId], references: [id])
  
  @@unique([pageVersionId, revisionNumber])
  @@index([pageVersionId, isLatest])
  @@index([pageVersionId, timestamp])
  @@index([revisionNumber])
  @@index([timestamp])
}

model User {
  id                   Int            @id @default(autoincrement())
  wikidotId            Int?           @unique
  displayName          String?
  firstActivityAt      DateTime?
  firstActivityType    String?
  firstActivityDetails String?
  lastActivityAt       DateTime?
  
  votes         Vote[]
  revisions     Revision[]
  attributions  Attribution[]
  stats         UserStats?
  tagPreferences       UserTagPreference[]
  voteInteractionsFrom UserVoteInteraction[] @relation("VoteInteractionFrom")
  voteInteractionsTo   UserVoteInteraction[] @relation("VoteInteractionTo")

  @@index([firstActivityAt])
  @@index([firstActivityType])
  @@index([lastActivityAt])
}

model UserStats {
  id            Int  @id @default(autoincrement())
  userId        Int  @unique
  totalUp       Int
  totalDown     Int
  totalRating   Int
  favTag        String?
  
  // User Rating and Ranking System
  overallRating      Decimal?  @db.Decimal(10, 2) @default(0)
  overallRank        Int?
  pageCount          Int       @default(0)
  
  // SCP Category (原创 + scp)
  scpRating          Decimal?  @db.Decimal(10, 2) @default(0)
  scpRank            Int?
  scpPageCount       Int       @default(0)
  
  // Translation Category (翻译)
  translationRating  Decimal?  @db.Decimal(10, 2) @default(0)
  translationRank    Int?
  translationPageCount Int     @default(0)
  
  // GOI Category (原创 + goi格式)
  goiRating          Decimal?  @db.Decimal(10, 2) @default(0)
  goiRank            Int?
  goiPageCount       Int       @default(0)
  
  // Story Category (原创 + 故事)
  storyRating        Decimal?  @db.Decimal(10, 2) @default(0)
  storyRank          Int?
  storyPageCount     Int       @default(0)
  
  // Wanderers/Library Category (原创 + wanderers)
  wanderersRating    Decimal?  @db.Decimal(10, 2) @default(0)
  wanderersRank      Int?
  wanderersPageCount Int       @default(0)
  
  // Art Category (原创 + 艺术作品)
  artRating          Decimal?  @db.Decimal(10, 2) @default(0)
  artRank            Int?
  artPageCount       Int       @default(0)
  
  ratingUpdatedAt    DateTime? @default(now())
  
  user          User @relation(fields: [userId], references: [id])
  
  @@index([overallRating(sort: Desc)])
  @@index([overallRank(sort: Asc)])
  @@index([scpRating(sort: Desc)])
  @@index([scpRank(sort: Asc)])
  @@index([translationRating(sort: Desc)])
  @@index([translationRank(sort: Asc)])
  @@index([goiRating(sort: Desc)])
  @@index([goiRank(sort: Asc)])
  @@index([storyRating(sort: Desc)])
  @@index([storyRank(sort: Asc)])
  @@index([wanderersRating(sort: Desc)])
  @@index([wanderersRank(sort: Asc)])
  @@index([artRating(sort: Desc)])
  @@index([artRank(sort: Asc)])
}

model UserTagPreference {
  id           Int      @id @default(autoincrement())
  userId       Int
  tag          String
  upvoteCount  Int       @default(0)
  downvoteCount Int      @default(0)
  totalVotes   Int       @default(0)
  lastVoteAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user         User     @relation(fields: [userId], references: [id])

  @@unique([userId, tag])
  @@index([userId])
  @@index([tag])
  @@index([totalVotes])
}

model UserVoteInteraction {
  id           Int      @id @default(autoincrement())
  fromUserId   Int
  toUserId     Int
  upvoteCount  Int       @default(0)
  downvoteCount Int      @default(0)
  totalVotes   Int       @default(0)
  lastVoteAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  fromUser     User     @relation("VoteInteractionFrom", fields: [fromUserId], references: [id])
  toUser       User     @relation("VoteInteractionTo", fields: [toUserId], references: [id])

  @@unique([fromUserId, toUserId])
  @@index([fromUserId])
  @@index([toUserId])
  @@index([totalVotes])
}

model Vote {
  id            Int            @id @default(autoincrement())
  pageVersionId Int
  timestamp     DateTime
  direction     Int
  userId        Int?
  anonKey       String?        // For anonymous votes when userId is null
  
  pageVersion   PageVersion    @relation(fields: [pageVersionId], references: [id])
  user          User?          @relation(fields: [userId], references: [id])
  
  // Fixed unique constraint that handles NULL userId properly
  @@unique([pageVersionId, userId, timestamp], name: "Vote_unique_constraint")
  @@unique([pageVersionId, anonKey, timestamp], name: "Vote_anon_unique_constraint")
  @@index([pageVersionId, direction])
  @@index([pageVersionId, timestamp])
  @@index([userId])
}

