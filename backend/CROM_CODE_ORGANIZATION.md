# SCPPER-CN CROMä»£ç æ•´ç†æ–‡æ¡£

## ğŸ“ ç›®å½•ç»“æ„æ¦‚è§ˆ

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ sync/                 # CROMæ•°æ®åŒæ­¥ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ archive/         # å·²åºŸå¼ƒçš„å†å²ç‰ˆæœ¬
â”‚   â”‚   â”œâ”€â”€ database-sync.js # ğŸŒŸ å½“å‰ä¸»è¦æ•°æ®åº“åŒæ­¥è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ final-sync.js    # ğŸŒŸ æœ€ç»ˆæ•´åˆçš„åŒæ­¥è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ full-data-pull.js # å®Œæ•´æ•°æ®æ‹‰å–è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ schema-explorer.js # CROM APIç»“æ„æ¢ç´¢
â”‚   â”‚   â””â”€â”€ sqlite-test.js   # SQLiteæµ‹è¯•è„šæœ¬
â”‚   â””â”€â”€ analysis/            # æ•°æ®åˆ†æç›¸å…³
â”‚       â”œâ”€â”€ user-analytics.js # ç”¨æˆ·åˆ†æç³»ç»Ÿ
â”‚       â”œâ”€â”€ database-user-query.js # æ•°æ®åº“æŸ¥è¯¢æ¥å£ 
â”‚       â””â”€â”€ ...
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma        # æ•°æ®åº“ç»“æ„å®šä¹‰
â”œâ”€â”€ resume-sync-data/        # åŒæ­¥æ•°æ®å’Œæ£€æŸ¥ç‚¹
â””â”€â”€ user-analysis/          # ç”¨æˆ·åˆ†æç»“æœ
```

## ğŸ¯ æ ¸å¿ƒè„šæœ¬åˆ†ç±»

### A. ç”Ÿäº§å°±ç»ªè„šæœ¬ âœ…

#### 1. `database-sync.js` - æ•°æ®åº“åŒæ­¥æœåŠ¡
**ç”¨é€”**: ç”Ÿäº§ç¯å¢ƒçš„å®Œæ•´æ•°æ®åº“åŒæ­¥è„šæœ¬
**åŠŸèƒ½**:
- åŸºäºrevisionæ•°é‡æ£€æµ‹é¡µé¢å˜æ›´
- é¡µé¢å†å²ç‰ˆæœ¬ç®¡ç†
- åˆ é™¤é¡µé¢æ£€æµ‹å’Œç”¨æˆ·è¯„åˆ†é‡è®¡ç®—
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’ŒåŒæ­¥æ—¥å¿—

**è¿è¡Œæ–¹å¼**:
```bash
node src/sync/database-sync.js
```

#### 2. `final-sync.js` - æœ€ç»ˆæ•´åˆè„šæœ¬
**ç”¨é€”**: é›†æˆæ‰€æœ‰ä¼˜åŒ–åŠŸèƒ½çš„ä¸»åŒæ­¥è„šæœ¬
**åŠŸèƒ½**:
- æ–­ç‚¹ç»­ä¼ 
- æ™ºèƒ½é¢‘ç‡æ§åˆ¶ (â‰¤2 req/sec)
- å®Œæ•´æ•°æ®æ‹‰å– (é¡µé¢+æŠ•ç¥¨+ä¿®è®¢+ç”¨æˆ·)
- JSONæ•°æ®æŒä¹…åŒ–

**è¿è¡Œæ–¹å¼**:
```bash
node src/sync/final-sync.js
```

#### 3. `user-analytics.js` - ç”¨æˆ·åˆ†æç³»ç»Ÿ
**ç”¨é€”**: ç»¼åˆç”¨æˆ·æ•°æ®åˆ†æå’Œæ’è¡Œæ¦œç”Ÿæˆ
**åŠŸèƒ½**:
- 27,499ç”¨æˆ·æ•°æ®æŒ–æ˜
- æŠ•ç¥¨å…³ç³»åˆ†æ
- åˆè‘—è¯„åˆ†ä¿®æ­£
- æ—¶é—´åºåˆ—å¯è§†åŒ–å‡†å¤‡

### B. å¼€å‘æµ‹è¯•è„šæœ¬ ğŸ§ª

#### 1. `schema-explorer.js` - APIç»“æ„æ¢ç´¢
**ç”¨é€”**: åˆ†æCROM GraphQL APIçš„æ•°æ®ç»“æ„
**åŠŸèƒ½**: æ¢ç´¢å¯ç”¨å­—æ®µå’Œæ•°æ®å…³ç³»

#### 2. `sqlite-test.js` - æ•°æ®åº“æµ‹è¯•
**ç”¨é€”**: SQLiteé›†æˆæµ‹è¯•
**åŠŸèƒ½**: éªŒè¯æ•°æ®åº“æ“ä½œå’ŒæŸ¥è¯¢æ€§èƒ½

#### 3. `full-data-pull.js` - å®Œæ•´æ•°æ®æ‹‰å–
**ç”¨é€”**: ä¸€æ¬¡æ€§å…¨é‡æ•°æ®è·å–
**åŠŸèƒ½**: 30,849é¡µé¢å®Œæ•´æ•°æ®æ‹‰å–

### C. å·²åºŸå¼ƒè„šæœ¬ ğŸ—‚ï¸ (archive/)

æ‰€æœ‰archive/ç›®å½•ä¸‹çš„è„šæœ¬éƒ½æ˜¯å¼€å‘è¿‡ç¨‹ä¸­çš„å†å²ç‰ˆæœ¬ï¼Œå·²è¢«æ›´å¥½çš„ç‰ˆæœ¬æ›¿ä»£ï¼š

- `test-full-sync.js` â†’ è¢« `final-sync.js` æ›¿ä»£
- `optimized-sync.js` â†’ è¢« `database-sync.js` æ›¿ä»£  
- `optimized-full-pull.js` â†’ è¢« `full-data-pull.js` æ›¿ä»£
- `rate-limited-pull.js` â†’ é¢‘ç‡æ§åˆ¶é›†æˆåˆ°ä¸»è„šæœ¬
- `resume-pull.js` â†’ æ–­ç‚¹ç»­ä¼ é›†æˆåˆ°ä¸»è„šæœ¬
- `fixed-resume-pull.js` â†’ é—®é¢˜ä¿®å¤ç‰ˆæœ¬
- `diagnose-users.js` â†’ ç”¨æˆ·é—®é¢˜è¯Šæ–­ï¼Œå·²è§£å†³

## ğŸš€ æ¨èä½¿ç”¨è„šæœ¬

### 1. æ—¥å¸¸æ•°æ®åŒæ­¥
```bash
# æ¨èï¼šä½¿ç”¨æ•°æ®åº“åŒæ­¥ï¼ˆæ”¯æŒå¢é‡æ›´æ–°ï¼‰
node src/sync/database-sync.js

# å¤‡é€‰ï¼šä½¿ç”¨æœ€ç»ˆæ•´åˆè„šæœ¬ï¼ˆJSONæ ¼å¼ï¼‰
node src/sync/final-sync.js
```

### 2. æ•°æ®åˆ†ææŸ¥è¯¢
```bash
# ç”¨æˆ·æ¡£æ¡ˆæŸ¥è¯¢
node src/analysis/database-user-query.js user "AndyBlocker"

# ç”¨æˆ·åˆ†æç³»ç»Ÿ
node src/analysis/user-analytics.js
```

### 3. åˆæ¬¡éƒ¨ç½²æˆ–å®Œæ•´é‡å»º
```bash
# 1. å®Œæ•´æ•°æ®æ‹‰å–
node src/sync/full-data-pull.js

# 2. ç”¨æˆ·åˆ†æ
node src/analysis/user-analytics.js

# 3. å¯åŠ¨æ•°æ®åº“åŒæ­¥
node src/sync/database-sync.js
```

## ğŸ“Š æ•°æ®æµç¨‹å›¾

```
CROM GraphQL API
       â†“
[final-sync.js] â†’ JSONæ–‡ä»¶ â†’ [user-analytics.js] â†’ ç”¨æˆ·æ’è¡Œæ¦œ
       â†“
[database-sync.js] â†’ PostgreSQL â†’ [database-user-query.js] â†’ æŸ¥è¯¢æ¥å£
       â†“
é¡µé¢å†å²ç‰ˆæœ¬ç®¡ç† & åˆ é™¤æ£€æµ‹
```

## ğŸ› ï¸ é…ç½®æ–‡ä»¶

### ç¯å¢ƒå˜é‡ (.env)
```env
# CROM API
CROM_API_URL=https://apiv1.crom.avn.sh/graphql
TARGET_SITE_URL=http://scp-wiki-cn.wikidot.com

# æ•°æ®åº“
DATABASE_URL=postgresql://user:password@localhost/scpper_cn
```

### é¢‘ç‡é™åˆ¶é…ç½®
- æœ€å¤§è¯·æ±‚é¢‘ç‡: 2 requests/second
- é…é¢é™åˆ¶: 300,000 points per 5-minute window
- è‡ªåŠ¨æ–­ç‚¹ç»­ä¼ æ”¯æŒ

## ğŸ”§ ç»´æŠ¤å»ºè®®

### åº”è¯¥ä¿ç•™çš„æ–‡ä»¶
- âœ… `database-sync.js` - ä¸»è¦åŒæ­¥è„šæœ¬
- âœ… `final-sync.js` - å¤‡ç”¨åŒæ­¥è„šæœ¬  
- âœ… `user-analytics.js` - åˆ†æç³»ç»Ÿ
- âœ… `database-user-query.js` - æŸ¥è¯¢æ¥å£
- âœ… `schema-explorer.js` - APIæ¢ç´¢å·¥å…·

### å¯ä»¥æ¸…ç†çš„æ–‡ä»¶
- ğŸ—‘ï¸ `archive/` æ•´ä¸ªç›®å½• (7ä¸ªå†å²è„šæœ¬)
- ğŸ—‘ï¸ `sqlite-test.js` (å¦‚æœä¸ä½¿ç”¨SQLite)
- ğŸ—‘ï¸ `full-data-pull.js` (å¦‚æœåªä½¿ç”¨å¢é‡åŒæ­¥)

### å»ºè®®çš„æ¸…ç†æ“ä½œ
```bash
# å®‰å…¨èµ·è§ï¼Œå…ˆç§»åŠ¨åˆ°ä¸´æ—¶ç›®å½•
mv src/sync/archive /tmp/scpper-archive-backup

# å¦‚æœç¡®è®¤ä¸éœ€è¦ï¼Œå¯ä»¥åˆ é™¤
# rm -rf /tmp/scpper-archive-backup
```

## ğŸ“ˆ æ€§èƒ½ç‰¹å¾

| è„šæœ¬ | å†…å­˜å ç”¨ | å¤„ç†é€Ÿåº¦ | æ–­ç‚¹ç»­ä¼  | æ•°æ®æ ¼å¼ |
|------|----------|----------|----------|----------|
| database-sync.js | ä¸­ç­‰ | 2 pages/sec | âœ… | PostgreSQL |
| final-sync.js | é«˜ | 2 pages/sec | âœ… | JSON |
| user-analytics.js | é«˜ | - | - | JSONè¾“å‡º |

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–

1. **ä»£ç æ¸…ç†**: åˆ é™¤archiveç›®å½•ä¸‹çš„åºŸå¼ƒè„šæœ¬
2. **æ–‡æ¡£å®Œå–„**: ä¸ºä¸»è¦è„šæœ¬æ·»åŠ è¯¦ç»†æ³¨é‡Š
3. **é”™è¯¯å¤„ç†**: ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œæ—¥å¿—æ ¼å¼
4. **é…ç½®ç®¡ç†**: é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®å‚æ•°