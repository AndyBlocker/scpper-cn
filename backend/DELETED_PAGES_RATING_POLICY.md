# å·²åˆ é™¤é¡µé¢Ratingå¤„ç†ç­–ç•¥

## é—®é¢˜èƒŒæ™¯

åœ¨ç»´æŠ¤ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯æ—¶ï¼Œéœ€è¦æ˜ç¡®å¦‚ä½•å¤„ç†å·²åˆ é™¤é¡µé¢çš„ratingå’Œç›¸å…³æ•°æ®ï¼Œè¿™ç›´æ¥å½±å“åˆ°ç”¨æˆ·è¯„åˆ†ã€æ’åå’Œç»Ÿè®¡æ•°æ®çš„å‡†ç¡®æ€§ã€‚

## ğŸ¯ æ ¸å¿ƒåŸåˆ™ï¼šæ’é™¤å·²åˆ é™¤é¡µé¢

**å†³å®š**ï¼šç”¨æˆ·ç»Ÿè®¡ä¸­**å®Œå…¨æ’é™¤**å·²åˆ é™¤é¡µé¢çš„ratingå’Œç›¸å…³æ•°æ®ã€‚

**ç†ç”±**ï¼š
1. **æ•°æ®ä¸€è‡´æ€§**ï¼šå·²åˆ é™¤é¡µé¢ä¸å†ä»£è¡¨ç”¨æˆ·çš„å½“å‰åˆ›ä½œæˆæœ
2. **å…¬å¹³æ€§**ï¼šé¿å…å› å†å²åˆ é™¤å½±å“å½“å‰æ’å
3. **å‡†ç¡®æ€§**ï¼šåæ˜ ç”¨æˆ·å½“å‰çš„å®é™…å½±å“åŠ›

## ğŸ“Š å…·ä½“å®æ–½ç­–ç•¥

### 1. ç”¨æˆ·é¡µé¢ç»Ÿè®¡

```sql
-- âœ… æ­£ç¡®åšæ³•ï¼šæ’é™¤å·²åˆ é™¤é¡µé¢
SELECT 
  p.created_by_user as user_name,
  COUNT(*) as page_count,
  SUM(p.rating) as total_rating,
  AVG(p.rating::float) as mean_rating
FROM pages p 
WHERE p.created_by_user IS NOT NULL 
  AND p.is_deleted = false  -- å…³é”®ï¼šæ’é™¤å·²åˆ é™¤é¡µé¢
GROUP BY p.created_by_user
```

### 2. åˆ†ç±»é¡µé¢è®¡æ•°

```javascript
// SCPã€æ•…äº‹ç­‰åˆ†ç±»ç»Ÿè®¡ä¹Ÿæ’é™¤å·²åˆ é™¤é¡µé¢
const scpCount = await prisma.page.count({
  where: { 
    createdByUser: user.name, 
    isDeleted: false,  // âœ… æ’é™¤å·²åˆ é™¤é¡µé¢
    OR: [
      { category: 'scp' },
      { url: { contains: '/scp-' } }
    ]
  }
});
```

### 3. æŠ•ç¥¨è®°å½•å¤„ç†

**ç­–ç•¥**ï¼šä¿ç•™æ‰€æœ‰æŠ•ç¥¨è®°å½•ï¼Œä½†åœ¨ç»Ÿè®¡æ—¶åªè®¡ç®—æ´»è·ƒé¡µé¢çš„æŠ•ç¥¨

```javascript
// è®¡ç®—ç”¨æˆ·è·å¾—çš„æŠ•ç¥¨æ€»æ•°ï¼ˆåªè®¡ç®—æ´»è·ƒé¡µé¢ï¼‰
const totalVotes = await prisma.voteRecord.aggregate({
  where: {
    page: { 
      createdByUser: user.name,
      isDeleted: false  // âœ… åªè®¡ç®—æ´»è·ƒé¡µé¢çš„æŠ•ç¥¨
    }
  },
  _count: { id: true }
});
```

## ğŸ”„ å†å²æ•°æ®å¤„ç†

### é¡µé¢åˆ é™¤æ—¶çš„å¤„ç†æµç¨‹

1. **è½¯åˆ é™¤æ ‡è®°**
   ```javascript
   await prisma.page.update({
     where: { url: pageUrl },
     data: {
       isDeleted: true,
       deletedAt: new Date(),
       deletionReason: 'é¡µé¢åœ¨æºç«™ç‚¹ä¸­ä¸å†å­˜åœ¨'
     }
   });
   ```

2. **åˆ›å»ºåˆ é™¤å†å²è®°å½•**
   ```javascript
   await prisma.pageHistory.create({
     data: {
       pageUrl: pageUrl,
       versionNumber: nextVersion,
       changeType: 'deleted',
       changeReason: 'é¡µé¢åœ¨æºç«™ç‚¹ä¸­è¢«åˆ é™¤',
       capturedAt: new Date()
     }
   });
   ```

3. **è‡ªåŠ¨é‡æ–°è®¡ç®—ç”¨æˆ·ç»Ÿè®¡**
   - æ‰€æœ‰ä¾èµ–è¯¥é¡µé¢çš„ç”¨æˆ·ç»Ÿè®¡è‡ªåŠ¨æ›´æ–°
   - æ’åé‡æ–°è®¡ç®—

## ğŸ“ˆ ç»Ÿè®¡å­—æ®µè¯´æ˜

### Userè¡¨ä¸­å—å½±å“çš„å­—æ®µ

| å­—æ®µå | è®¡ç®—æ–¹å¼ | æ˜¯å¦æ’é™¤å·²åˆ é™¤é¡µé¢ |
|--------|----------|-------------------|
| `pageCount` | COUNT(pages) | âœ… æ˜¯ |
| `totalRating` | SUM(rating) | âœ… æ˜¯ |
| `meanRating` | AVG(rating) | âœ… æ˜¯ |
| `pageCountScp` | COUNT(scpç±»å‹é¡µé¢) | âœ… æ˜¯ |
| `pageCountTale` | COUNT(æ•…äº‹ç±»å‹é¡µé¢) | âœ… æ˜¯ |
| `pageCountGoiFormat` | COUNT(GOIæ ¼å¼é¡µé¢) | âœ… æ˜¯ |
| `rank` | åŸºäºtotalRatingæ’å | âœ… æ˜¯ |

## ğŸ›¡ï¸ æ•°æ®å®Œæ•´æ€§ä¿éšœ

### 1. ä¿ç•™å†å²è®°å½•
- **æŠ•ç¥¨è®°å½•**ï¼šå®Œæ•´ä¿ç•™ï¼Œä¾¿äºå†å²åˆ†æ
- **ä¿®è®¢è®°å½•**ï¼šå®Œæ•´ä¿ç•™ï¼Œä¾¿äºè¿½è¸ªå˜æ›´
- **é¡µé¢å†å²**ï¼šå®Œæ•´ä¿ç•™ï¼ŒåŒ…å«åˆ é™¤è®°å½•

### 2. å¯è¿½æº¯æ€§
```sql
-- æŸ¥çœ‹ç”¨æˆ·å†å²æ€»è¯„åˆ†ï¼ˆåŒ…å«å·²åˆ é™¤é¡µé¢ï¼‰
SELECT 
  SUM(rating) as historical_total_rating
FROM page_histories ph
WHERE ph.page_url IN (
  SELECT url FROM pages WHERE created_by_user = 'user_name'
)
AND ph.change_type != 'deleted';
```

### 3. å®¡è®¡åŠŸèƒ½
```sql
-- æŸ¥çœ‹ç”¨æˆ·å› é¡µé¢åˆ é™¤æŸå¤±çš„è¯„åˆ†
SELECT 
  COUNT(*) as deleted_pages,
  SUM(rating) as lost_rating
FROM pages 
WHERE created_by_user = 'user_name' 
  AND is_deleted = true;
```

## ğŸ”§ å®æ–½çŠ¶æ€

### âœ… å·²ä¿®å¤çš„è„šæœ¬
- **v1 æ•°æ®åº“åŒæ­¥** (`database-sync.js`): âœ… æ­£ç¡®å®æ–½
- **v2 æ•°æ®åº“åŒæ­¥** (`apiv2-database-sync-final.js`): âœ… å·²ä¿®å¤

### âŒ éœ€è¦ä¿®å¤çš„è„šæœ¬
- **v2 æ•°æ®åº“åŒæ­¥** (`apiv2-database-sync-fixed.js`): âŒ æœ‰ç¼ºé™·ï¼Œå·²è¢«finalç‰ˆæœ¬æ›¿ä»£

## ğŸ“‹ éªŒè¯æ¸…å•

åœ¨ä»»ä½•ç”¨æˆ·ç»Ÿè®¡æŸ¥è¯¢ä¸­ï¼Œç¡®ä¿åŒ…å«ä»¥ä¸‹æ¡ä»¶ï¼š

```sql
-- âœ… æ£€æŸ¥æ¸…å•
WHERE p.is_deleted = false  -- å¿…é¡»åŒ…å«
```

**å…·ä½“åº”ç”¨åœºæ™¯**ï¼š
- [x] ç”¨æˆ·é¡µé¢è®¡æ•°
- [x] ç”¨æˆ·æ€»è¯„åˆ†è®¡ç®—
- [x] ç”¨æˆ·å¹³å‡è¯„åˆ†è®¡ç®—
- [x] åˆ†ç±»é¡µé¢ç»Ÿè®¡
- [x] ç”¨æˆ·æ’åè®¡ç®—
- [x] æŠ•ç¥¨æ•°æ®ç»Ÿè®¡

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

1. **ä¸€è‡´æ€§åŸåˆ™**ï¼šæ‰€æœ‰ç”¨æˆ·ç›¸å…³ç»Ÿè®¡éƒ½åº”æ’é™¤å·²åˆ é™¤é¡µé¢
2. **é€æ˜åº¦**ï¼šåœ¨ç•Œé¢ä¸Šæ˜ç¡®è¯´æ˜ç»Ÿè®¡åŸºäºæ´»è·ƒé¡µé¢
3. **å†å²åˆ†æ**ï¼šæä¾›å•ç‹¬çš„å†å²åˆ†æåŠŸèƒ½ï¼Œå¯é€‰æ‹©åŒ…å«å·²åˆ é™¤é¡µé¢
4. **å®šæœŸå®¡è®¡**ï¼šå®šæœŸæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§ï¼Œç¡®ä¿ç»Ÿè®¡å‡†ç¡®

## ğŸ”® æœªæ¥è€ƒè™‘

### å¯èƒ½çš„æ‰©å±•åŠŸèƒ½
1. **ç”¨æˆ·å†å²å½±å“åŠ›å›¾è¡¨**ï¼šå±•ç¤ºç”¨æˆ·è¯„åˆ†éšæ—¶é—´å˜åŒ–ï¼ˆåŒ…æ‹¬åˆ é™¤äº‹ä»¶ï¼‰
2. **åˆ é™¤é¡µé¢æ¡£æ¡ˆ**ï¼šä¸ºæ„Ÿå…´è¶£çš„ç”¨æˆ·æä¾›å†å²é¡µé¢æŸ¥çœ‹
3. **å½±å“åŠ›æ¢å¤**ï¼šå¦‚æœåˆ é™¤é¡µé¢è¢«æ¢å¤ï¼Œè‡ªåŠ¨æ¢å¤ç›¸å…³ç»Ÿè®¡

### é…ç½®é€‰é¡¹
æœªæ¥å¯è€ƒè™‘æä¾›é…ç½®é€‰é¡¹ï¼Œå…è®¸ç®¡ç†å‘˜é€‰æ‹©ä¸åŒçš„ç»Ÿè®¡ç­–ç•¥ï¼š
- `EXCLUDE_DELETED`: é»˜è®¤ï¼Œæ’é™¤å·²åˆ é™¤é¡µé¢
- `INCLUDE_DELETED`: åŒ…å«å·²åˆ é™¤é¡µé¢ï¼ˆç”¨äºå†å²åˆ†æï¼‰
- `WEIGHTED_DELETED`: ç»™å·²åˆ é™¤é¡µé¢é™æƒé‡